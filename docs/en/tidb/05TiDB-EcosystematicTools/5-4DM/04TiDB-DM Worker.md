# DM Worker

## What's DM Worker

DM Worker starts from the [func start](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/worker/server.go#L106-L108) then starts a series of componnets including `startKeepAlive`, `RelayHandler`, `SubTasks`, `Syncer`. About the relay config, there's a [logic](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/worker/server.go#L160-L164) to adjust wether use remote MySQL Binlog or Local relay log.

![DM_Worker_Components](../../../../../images/tidb/05TiDB-EcosystematicTools/5-4DM/03-DM_Worker_Components.jpeg)

## KeepAlive

1. **What's the functionality.** DM Worker keepalive with master. If worker loses connect from master, it would stop all task and try to connect master again.

2. **How does it work.** The [defaultKeepAliveTTL](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/worker/join.go#L103) is 1 minutes, which periodically use [etcd cli.Grant](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/pkg/ha/keepalive.go#L116) to put kv with TTL to etcd. In that way, DM Master could be able to transter subtask into another alive DM Worker if there's something seriously wrong with the worker which already has bounded with one specific MySQL Binlog.

## Relay

1. **How to detect if it's configed.** When configuration cannot be obtained from DM Master, which means the task was already deleted or hasn't been configed, that starting [logic](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/worker/server.go#L183-L185) goes inside the [func enableHandleSubtasks](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/worker/server.go#L686-L688) to justify wether to use Realy log.  

2. **How to work if it's configed.** I recommend you to have more relay implmented info in [this article - DM 源码阅读系列文章（六）relay log 的实现](https://cn.pingcap.com/blog/dm-source-code-reading-6) (BTW: you need english version might  changing by yourself). In short, Relay log is a bridge function avoiding suddenly remote MySQL Binlog disappearing, and it's implmented by that firstly read every useful binlog, like insert/update... using [GetEvent](https://github.com/pingcap/dm/blob/f6f0566424/relay/reader/reader.go#L128), then write into relay log dir as below. DM Worker uses relay when enabled, and calls [func parseFile](https://github.com/pingcap/dm/blob/f6f0566424/pkg/streamer/reader.go#L244) to parse Relay log to syncer.  
    **a. server-uuid.index** : An index already organized binglog events to provide a structure to index where to read.  
    **b. 842965eb-091c-11e9-9e45-9a3bff03fa39** : Dir generated by the [func utils.AddSuffixForUUID](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/relay/meta.go#L279) in format of `fmt.Sprintf("%s%s%06d", uuid, uuidIndexSeparator, id)`.  
    **c. relay.meta** : Record current prorocess or progress.  
    **d. mysql-bin.00000X** : The max number of X is the newest file which's being written.  

    ```shell
    <deploy_dir>/relay_log/
    |-- 7e427cc0-091c-11e9-9e45-72b7c59d52d7.000001
    |   |-- mysql-bin.000001
    |   |-- mysql-bin.000002
    |   |-- mysql-bin.000003
    |   |-- mysql-bin.000004
    |   `-- relay.meta
    |-- 842965eb-091c-11e9-9e45-9a3bff03fa39.000002
    |   |-- mysql-bin.000001
    |   `-- relay.meta
    `--  server-uuid.index
    ```

## SubTasks

1. **What does it mean.** SubTask represents a sub task of data migration. In other words, the number of subtasks is equal to MySQL Binlog number. All because they have 1-1 replationship. we can see the one by [it's struct](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/worker/subtask.go#L77) below. As we all know, one working worker has only one binlog till now.  One noticeable feature is PingCAP is trying to decouple the 1-1 replationship, you can flow the progress by the tracking [Issue](https://github.com/pingcap/tiflow/issues/4687).

    ```go
    type SubTask struct {
    cfg *config.SubTaskConfig

    ......

    workerName string

    validator *syncer.DataValidator
    }
    ```

2. **How does it be created.** The mainly places to generate subTask from task is in [OpenAPITaskToSubTaskConfigs](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/master/openapi_controller.go#L386) and [StartTask](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/master/server.go#L510). Noticable, not just the only two, but also [UpdateTask](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/master/server.go#L725). But we're just foucsing on normally where it comes from. So, you can explore it by yourself if you're interested in.

## SourceWorker

1. **What does it responsible for.** SourceWorker manages a source(upstream) which is mainly related to subtasks and relay. It has lots of functions such as `updateSourceStatus`, `fetchSubTasksAndAdjust`, `operateRelay` and `PurgeRelay` ..., we can see what the functionality is.

2. **How does it work.** Just focusing on the main part(StartSubTask), I think, of SourceWorker functionalities. As mentioned before, when one DM Worker has been started, it'd gotten subTask config and Bound relationship by requesting to etcd. So following the calling chain of `EnableHandleSubtasks-->w.StartSubTask-->st.Run-->initUnits-->createUnits`, a working logic will be showed clearly. And, in [func createRealUnits](https://github.com/pingcap/tiflow/blob/c65e2b72198de10319008b31dcf13d51509ccfde/dm/worker/subtask.go#L52), there're some steps to adjust wether `ModeAll` or `ModeIncrement`. PLZ learn it by yourself if very interested in.

## Syncer

I've gotta say `Syncer` is the most important component of DM Worker, or even DM. So, It was splited into a single content to explain how it works. At [here](./05TiDB-DM%20syncer.md).
